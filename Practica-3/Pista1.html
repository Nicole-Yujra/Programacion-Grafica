<html lang="es">
<head>
    <title>anima</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>
<body >
    <canvas id="webglcanvas" style="border: none;" width="550" height="550"></canvas>
    <script id="vs" type="vertex">
        #version 300 es
        uniform mat4 uMatrizProyeccion;
        uniform vec2 uDesplaza;         
        uniform vec2 uEscala;           
        uniform float uAnguloZ;
        layout(location = 0) in vec2 aVertices;

        void main() {
            vec2 verticesEscalados = aVertices * uEscala;
            vec2 verticesRotados;
                verticesRotados.x = verticesEscalados.x * cos(uAnguloZ) - verticesEscalados.y * sin(uAnguloZ);
                verticesRotados.y = verticesEscalados.x * sin(uAnguloZ) + verticesEscalados.y * cos(uAnguloZ);
            vec2 vertices = verticesRotados + uDesplaza;
            gl_Position = uMatrizProyeccion * vec4(vertices, 0.0, 1.0);
        }
    </script>

    <script id="fs" type="fragment">
        #version 300 es
        precision mediump float;
        uniform vec4 uColor;
        out vec4 color;
        void main() {
            color = uColor;
        }
    </script>

    <script>
        function compilaEnlazaLosShaders() {
            /* Se compila el shader de vertice */
            var shaderDeVertice = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(shaderDeVertice, document.getElementById("vs").text.trim());
            gl.compileShader(shaderDeVertice);
            if (!gl.getShaderParameter(shaderDeVertice, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shaderDeVertice));
            }
            /* Se compila el shader de fragmento */
            var shaderDeFragmento = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(shaderDeFragmento, document.getElementById("fs").text.trim());
            gl.compileShader(shaderDeFragmento);
            if (!gl.getShaderParameter(shaderDeFragmento, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shaderDeFragmento));
            }

            /* Se enlaza ambos shader */
            programaID = gl.createProgram();
            gl.attachShader(programaID, shaderDeVertice); 
            gl.attachShader(programaID, shaderDeFragmento);
            gl.linkProgram(programaID);
            if (!gl.getProgramParameter(programaID, gl.LINK_STATUS)) {
                console.error(gl.getProgramInfoLog(programaID));
            }

            /* Se instala el programa de shaders para utilizarlo */
            gl.useProgram(programaID);
        }

        function toRadians(grados) {
            return grados * Math.PI / 180;
        };

        /* Proyección Paralela - glOrtho */
        function ortho(r, izq, der, abj, arr, cerca, lejos) {
            r[0] = 2/(der - izq); r[4] =             0; r[ 8] =                  0; r[12] =         -(der + izq)/(der - izq);
            r[1] =             0; r[5] = 2/(arr - abj); r[ 9] =                  0; r[13] =         -(arr + abj)/(arr - abj);
            r[2] =             0; r[6] =             0; r[10] = -2/(lejos - cerca); r[14] = -(lejos + cerca)/(lejos - cerca);
            r[3] =             0; r[7] =             0; r[11] =                  0; r[15] =                                1;
        }

        // Se eliminan las funciones: identidad, traslacion, escalacion, rotacionZ, y multiplica
        
        function codigodevertices(){
            codigoVertices = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, codigoVertices);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(0);
            gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            codigoColores = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, codigoColores);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colores), gl.STATIC_DRAW);
            gl.enableVertexAttribArray(1);
            gl.vertexAttribPointer(1, 4, gl.FLOAT, false, 0, 0);
        }

        let MatrizProyeccion = new Array(16);
        let uMatrizProyeccion;
        let uColor;
        let uDesplaza;
        let uEscala; 
        let uAnguloZ; 
        let canvas, gl,radio;
        let avanza1=0,avanza2=0,avanza3=0;
        let codigoVertices,codigoColores,colores;
        let vertices;
        let rayas,rayasVAO;
        let avanazaRayas=0;
        let boton,iniciar=0;
        let acelera=0, derecha=0,frena=0,izquierda=0;
        let contador1=0.01,contador2=0,contador3=0.01;
        let desplazar1=0,desplazar2=0,desplazar3=0;
        let conde1=0,conde3=0;
        let aumentar=0.06;
        let tiempo =0;


        function circulo(radio){
            vertices = [];
            colores = [];
            for (var i = 0; i < 360; i++) {
                vertices.push(radio * Math.cos(i * Math.PI / 180));
                vertices.push(radio * Math.sin(i * Math.PI / 180));
            }
        }       

        class Pista{
            constructor(){
                vertices = [
                    -2.3,-5,
                    2.3,-5,
                    2.3,5,
                    -2.3,5,

                    -2.15,-5,
                    -2.1,-5,
                    -2.1,5,
                    -2.15,5,

                    2.15,-5,
                    2.1,-5,
                    2.1,5,
                    2.15,5,
                ];

                this.pistaVAO = gl.createVertexArray();
                gl.bindVertexArray(this.pistaVAO);

                codigodevertices();
            }
            dibuja(){
                gl.bindVertexArray(this.pistaVAO);
                gl.uniform4f(uColor, 72/255, 72/255, 72/255, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
                gl.uniform4f(uColor, 1,1,0, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 4, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 8, 4);

                gl.bindVertexArray(null);
            }
        }
        
        class Auto{
            constructor(){
                vertices = [
                    //carroceria
                    -0.9,-4.5,0.9,-4.5,1,-4.4,1,-1.7,0.9,-1.5,-0.9,-1.5,-1,-1.7,-1,-4.4,
                    //ventana 1
                    -0.6,-2.9,0.6,-2.9,0.8,-2.3,-0.8,-2.3,            
                    //ventana2
                    -0.85,-4.1,-0.6,-4,-0.6,-3.1, -0.85,-2.4,  //3
                    //ventana3
                    0.85,-4.1,0.6,-4,  0.6,-3.1, 0.85,-2.4,  //3
                    //ventana4
                    -0.8,-4.2,  0.8,-4.2,  0.5,-4.1,-0.5,-4.1,
                    //rueda1
                    -1.15,-4.1,-0.9,-4.1, -0.9,-3.4,-1.15,-3.4,  //3
                    //rueda2
                    -1.15,-2.7, -0.9,-2.7,-0.9,-2,-1.15,-2,
                    //rueda3
                    1.15,-4.1,0.9,-4.1,  0.9,-3.4, 1.15,-3.4,  //3
                    //rueda4
                    1.15,-2.7, 0.9,-2.7,  0.9,-2, 1.15,-2,  //3
                ];

                this.autoVAO = gl.createVertexArray();
                gl.bindVertexArray(this.autoVAO);

                codigodevertices();
            }
            auto1(){
                gl.bindVertexArray(this.autoVAO);
                dibujarautos(1,0,0);
            }
            auto2(){
                gl.bindVertexArray(this.autoVAO);
                dibujarautos(0,1,0);
            }
            auto3(){
                gl.bindVertexArray(this.autoVAO);
                dibujarautos(0,0,1);
            }
        }
        
        function dibujarautos(a,b,c){
                gl.uniform4f(uColor, 0,0, 0, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 24, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 28, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 32, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 36, 4);
                gl.uniform4f(uColor, a, b, c, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, 8);
                gl.uniform4f(uColor, 0,200/255, 1, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 8, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 12, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 16, 4);
                gl.drawArrays(gl.TRIANGLE_FAN, 20, 4);
                gl.bindVertexArray(null);
        }
       
        class Rayas{
            constructor(){
                vertices = [
                    //----lineas 
                    -0.75,-2.5,
                    -0.70,-2.5,
                    -0.70,-2,
                    -0.75,-2,
                    // partida
                    -2.1,-3,
                    2.1,-3,
                    2.1,-2.8,
                    -2.1,-2.8,

                    // fin
                    -2,200,
                    2,200,
                    2,200.3,
                    -2,200.3,
                ];

                this.rayasVAO = gl.createVertexArray();
                gl.bindVertexArray(this.rayasVAO);

                codigodevertices();
            }
            
            dibuja(){
                let y =0,x=0;
                for (let i = 0; i < 220; i++) {
                    for (let j = 0; j < 2; j++) {
                        gl.bindVertexArray(this.rayasVAO);
                        gl.uniform2f(uDesplaza,x, y+ avanazaRayas); // Posición fija en el centro
                        gl.uniform4f(uColor, 1, 1, 1, 1);
                        gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
                        gl.bindVertexArray(null);
                        x=x+1.4;
                    }
                    x = 0;
                    y = y+1;
                }
                
            }
            partida(){
                gl.bindVertexArray(this.rayasVAO);
                gl.uniform4f(uColor, 1,1,1, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 4, 4);
                gl.bindVertexArray(null);
            }
            fin(){
                gl.bindVertexArray(this.rayasVAO);
                gl.uniform4f(uColor, 1,0,0, 1);
                gl.drawArrays(gl.TRIANGLE_FAN, 8, 4);
                gl.bindVertexArray(null);
            }
        }
        
        class Boton{
            constructor(){
                circulo(0.4);
                this.botonVAO = gl.createVertexArray();
                gl.bindVertexArray(this.botonVAO);
                codigodevertices();
            }
            boton1(){
                gl.bindVertexArray(this.botonVAO);
                dibujarBoton(1,0,0);
            }
            boton2(){
                gl.bindVertexArray(this.botonVAO);
                dibujarBoton(0,1,0);
            }
            boton3(){
                gl.bindVertexArray(this.botonVAO);
                dibujarBoton(0,0,1);
            }
            boton4(){
                gl.bindVertexArray(this.botonVAO);
                dibujarBoton(1,1,0);
            }
        }

        function dibujarBoton(a,b,c){
            gl.uniform4f(uColor, a, b, c, 1);
            gl.drawArrays(gl.TRIANGLE_FAN, 0, 360);

        }

        function distancia2(x1, y1, x2, y2) {
          return (x1 - x2) * (x1 - x2) + (y1 - y2) * (y1 - y2);
        }

        function puntoEstaDentroDelCirculo(posx, posy, x, y, radio) {
          return (distancia2(posx, posy, x, y) < radio * radio);
        }

        function mouseDown(event){
            var posx = new Number();
            var posy = new Number();

            /* Obtiene la coordenada dentro del canvas */
            posx = event.x - canvas.offsetLeft;
            posy = event.y - canvas.offsetTop;

            //alert("posx: " + posx + "  posy: " + posy);

            /* En coordenadas del OpenGL */
            posx = ((posx / 550) * 10) - 5;
            posy = ((1 - posy / 550) * 10) - 5;

            //alert("posx: " + posx + "  posy: " + posy);
            let c=0, controlar=0;
            /* Verifica área elegida */
            if (puntoEstaDentroDelCirculo(posx, posy, 3.5, -2.4, 0.3)) {
                iniciar=1;
                acelera =1;
                contador2=contador2+0.002;
                contador1=contador1-Math.random()*0.009;
                contador3=contador3-Math.random()*0.009;
              
            }
            if (puntoEstaDentroDelCirculo(posx, posy, 4.2, -3, 0.3)) {
                derecha =1;
                contador2=contador2+0.0002;
                contador1=contador1+Math.random()*0.004;
                contador3=contador3-Math.random()*0.001;
                desplazar2=desplazar2+0.1;
                desplazar3=desplazar3-0.05;
                desplazar1=desplazar1-0.01;

            }
            if (puntoEstaDentroDelCirculo(posx, posy, 3.5, -3.6, 0.3)) {
                frena =1;
                contador2=contador2-0.002;
                contador1=contador1+Math.random()*0.001;
                contador3=contador3+Math.random()*0.001;
            }
            if (puntoEstaDentroDelCirculo(posx, posy, 2.8, -3, 0.3)) {
                izquierda =1;
                desplazar2 = desplazar2-0.1;
                contador2=contador2+0.0002;
                contador1=contador1-Math.random()*0.003;
                contador3=contador3+Math.random()*0.001;
                desplazar3=desplazar3+0.03;
                desplazar1=desplazar1+0.03;
             
            }
        }
        
        function dibuja(){
            gl.clear(gl.COLOR_BUFFER_BIT);
            //---------Pista-----------------------------------------
            gl.uniform2f(uDesplaza, 0, 0); // Posición fija en el centro
            gl.uniform2f(uEscala, 1, 1); 
            gl.uniform1f(uAnguloZ, 0); // Enviamos el ángulo en radianes
            pista.dibuja();
            rayas.dibuja();
            gl.uniform2f(uDesplaza, 0, avanazaRayas); // Posición fija en el centro
            gl.uniform2f(uEscala, 1, 1); 
            gl.uniform1f(uAnguloZ, 0);
            rayas.partida();
            gl.uniform2f(uDesplaza, 0, avanazaRayas); // Posición fija en el centro
            gl.uniform2f(uEscala, 1, 1); 
            gl.uniform1f(uAnguloZ, 0);
            rayas.fin();
            //autos------------------------------------------------------
            gl.uniform2f(uDesplaza, 0+desplazar2, -2.5+avanza2); // Posición fija en el centro
            gl.uniform2f(uEscala, 0.45, 0.45); 
            gl.uniform1f(uAnguloZ, 0);
            auto.auto2();

            gl.uniform2f(uDesplaza, 1.4+desplazar3, -2.5+avanza3); // Posición fija en el centro
            gl.uniform2f(uEscala, 0.45, 0.45); 
            gl.uniform1f(uAnguloZ, 0);
            auto.auto3();

            gl.uniform2f(uDesplaza, -1.4+desplazar1, -2.5+avanza1); // Posición fija en el centro
            gl.uniform2f(uEscala, 0.45, 0.45); 
            gl.uniform1f(uAnguloZ, 0);
            auto.auto1();
            tiempo=tiempo+1;
            if(tiempo<3580){
            if (iniciar==1) {
                avanazaRayas =avanazaRayas-0.06;
                if(acelera==1){
                    avanza1 = avanza1+contador1;
                    avanza2 = avanza2+contador2;
                    avanza3 = avanza3+contador3; 
                    derecha=0;
                    frena=0;
                    izquierda=0;
                }
                if(derecha==1){
                    avanza1 = avanza1+contador1;
                    avanza2 = avanza2+contador2;
                    avanza3 = avanza3+contador3; 
                    frena=0;
                    izquierda=0;
                    acelera=0;
                }
                if(frena==1){
                    avanza1 = avanza1+contador1;
                    avanza2 = avanza2+contador2;
                    avanza3 = avanza3+contador3; 
                    derecha=0;
                    acelera=0;
                    izquierda=0;
                }
                if(izquierda==1){
                    avanza1 = avanza1+contador1;
                    avanza2 = avanza2+contador2;
                    avanza3 = avanza3+contador3; 
                    derecha=0;
                    frena=0;
                    acelera=0;

                }
            }
            }else{
                avanza1 = 0;
                avanza3 = 0;
                avanza2 = 0;
                desplazar1=0;
                desplazar2=0;
                desplazar3=0;

                avanazaRayas=0;
            }
            console.log('tiempo');

            //--------BOTONES---------------
            gl.uniform2f(uDesplaza, 3.5, -2.4); // Posición fija en el centro
            gl.uniform2f(uEscala, 1,1); 
            boton.boton1();
            gl.uniform2f(uDesplaza, 4.2, -3); // Posición fija en el centro
            gl.uniform2f(uEscala, 1,1); 
            boton.boton2();
            gl.uniform2f(uDesplaza, 3.5, -3.6); // Posición fija en el centro
            gl.uniform2f(uEscala, 1,1); 
            boton.boton3();
            gl.uniform2f(uDesplaza, 2.8, -3); // Posición fija en el centro
            gl.uniform2f(uEscala, 1,1); 
            boton.boton4();

            requestAnimationFrame(dibuja);
           
        }

        function main(){
            canvas = document.getElementById("webglcanvas");
            gl = canvas.getContext("webgl2");

            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
          canvas.addEventListener("mousedown", mouseDown, false);

            compilaEnlazaLosShaders();

            gl.useProgram(programaID);

            pista= new Pista();
            rayas = new Rayas();
            auto = new Auto();
            boton= new Boton();
           
            uColor = gl.getUniformLocation(programaID, "uColor");
            uMatrizProyeccion = gl.getUniformLocation(programaID, "uMatrizProyeccion");
            
            // Obtener ubicaciones de los nuevos uniformes para las transformaciones
            uDesplaza = gl.getUniformLocation(programaID, "uDesplaza");
            uEscala = gl.getUniformLocation(programaID, "uEscala");
            uAnguloZ = gl.getUniformLocation(programaID, "uAnguloZ"); // Obtener uAnguloZ

            ortho(MatrizProyeccion, -5, 5, -5, 5, -1, 1);
            gl.uniformMatrix4fv(uMatrizProyeccion, false, MatrizProyeccion);

            gl.clearColor(0, 207/255, 100/255, 1); // r g b a 255 177 100 verde !!!

            
            dibuja();
        }
        window.onload = main;
    </script>
</body>
</html>