<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pista con texturas</title>
</head>
<body>
    <canvas id="webglcanvas" style="border: none;" width="552" height="552"></canvas>
    <img src="pista_1.jpg" id="imagenpista_1" hidden />
    <img src="pista_2.jpg" id="imagenpista_2" hidden />
    <img src="pista_3.jpg" id="imagenpista_3" hidden />
    <img src="auto_1.png" id="imagenauto_1" hidden />
    <img src="auto_2.png" id="imagenauto_2" hidden />
    <img src="auto_3.png" id="imagenauto_3" hidden />

    <script id="vs" type="vertex">
        #version 300 es
        precision mediump float;
        uniform mat4 uMatrizProyeccion;
        uniform mat4 uMatrizVista;
        uniform mat4 uMatrizModelo;
        layout(location = 0) in vec2 aVertices;
        layout(location = 1) in vec2 aCoordenadasDeTextura;
        out vec2 vCoordenadasDeTextura;
        void main() {
            vCoordenadasDeTextura = aCoordenadasDeTextura;  
            gl_Position = uMatrizProyeccion * uMatrizVista * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
        }
    </script>

    <script id="fs" type="fragment">
        #version 300 es
        precision mediump float;
        uniform sampler2D uUnidadDeTextura;
        in vec2 vCoordenadasDeTextura;
        out vec4 color;
        void main() {
            color = texture(uUnidadDeTextura, vCoordenadasDeTextura); 
        }
    </script>
    <script>
        'use strict';
        /* Variables globales */
        let gl;
        let programaID;
        let texturapista_1,cdt_1;
        let texturapista_2,cdt_2;
        let texturapista_3,cdt_3;
        let texturaauto_1,cdta_1;
        let texturaauto_2,cdta_2;
        let texturaauto_3,cdta_3;

        let inicio =0,partir=0;
        let p2y=5,p3y=15;
        let p1=0,p2=0,p3=0;
        let velocidad=0.06;
        let ax1=0,ay1=0,ax2=0,ay2=0,ax3=0,ay3=0;

        let uMatrizProyeccion;
        let uMatrizVista;
        let uMatrizModelo;
        let uUnidadDeTextura;
        let MatrizProyeccion = new Array(16);
        let MatrizVista = new Array(16);
        let MatrizModelo = new Array(16);

        function toRadians(grados) {
            return grados * Math.PI / 180;
        };

        /* Matriz Identidad */
        function identidad(r) {
            r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = 0;
            r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = 0;
            r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0;
            r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1;
        }

        /* Traslación - glTranslatef */
        function traslacion(matriz, tx, ty, tz) {
            let r = new Array(16);
            r[0] = 1; r[4] = 0; r[ 8] = 0; r[12] = tx;
            r[1] = 0; r[5] = 1; r[ 9] = 0; r[13] = ty;
            r[2] = 0; r[6] = 0; r[10] = 1; r[14] = tz;
            r[3] = 0; r[7] = 0; r[11] = 0; r[15] =  1;
            multiplica(matriz, matriz, r);
        }

        function escalacion(matriz, sx, sy, sz) { 
            let r = new Array(16);
            r[0] = sx; r[4] =  0; r[ 8] =  0; r[12] =  0;
            r[1] =  0; r[5] = sy; r[ 9] =  0; r[13] =  0;
            r[2] =  0; r[6] =  0; r[10] = sz; r[14] =  0;
            r[3] =  0; r[7] =  0; r[11] =  0; r[15] =  1;
            multiplica(matriz, matriz, r);
        }
        /* Proyección Paralela - glOrtho */
        function ortho(r, izq, der, abj, arr, cerca, lejos) {
            r[0] = 2/(der - izq); r[4] =             0; r[ 8] =                  0; r[12] =         -(der + izq)/(der - izq);
            r[1] =             0; r[5] = 2/(arr - abj); r[ 9] =                  0; r[13] =         -(arr + abj)/(arr - abj);
            r[2] =             0; r[6] =             0; r[10] = -2/(lejos - cerca); r[14] = -(lejos + cerca)/(lejos - cerca);
            r[3] =             0; r[7] =             0; r[11] =                  0; r[15] =                                1;
        }

        /* Multiplicación de matrices de 4 x 4 */
        function multiplica(c, a, b) {
            let r = new Array(16);
            let i, j, k;
            for (i = 0; i < 4; i++){
                for (j = 0; j < 4; j++){
                let s = 0;
                for (k = 0; k < 4; k++)
                    s = s + a[i + k * 4] * b[k + j * 4];
                    r[i + j * 4] = s;
                }
            }
            for (i = 0; i < 16; i++)
                c[i] = r[i];
        }


        function compilaEnlazaLosShaders() {
            /* Se compila el shader de vertice */
            let shaderDeVertice = gl.createShader(gl.VERTEX_SHADER);
            gl.shaderSource(shaderDeVertice, document.getElementById("vs").text.trim());
            gl.compileShader(shaderDeVertice);
            if (!gl.getShaderParameter(shaderDeVertice, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shaderDeVertice));
            }
            /* Se compila el shader de fragmento */
            let shaderDeFragmento = gl.createShader(gl.FRAGMENT_SHADER);
            gl.shaderSource(shaderDeFragmento, document.getElementById("fs").text.trim());
            gl.compileShader(shaderDeFragmento);
            if (!gl.getShaderParameter(shaderDeFragmento, gl.COMPILE_STATUS)) {
                console.error(gl.getShaderInfoLog(shaderDeFragmento));
            }
            /* Se enlaza ambos shader */
            programaID = gl.createProgram();
            gl.attachShader(programaID, shaderDeVertice); 
            gl.attachShader(programaID, shaderDeFragmento);
            gl.linkProgram(programaID);
            if (!gl.getProgramParameter(programaID, gl.LINK_STATUS)) {
                console.error(gl.getProgramInfoLog(programaID));
            }
        }

        class Rectangulo {
           // cambio gl por x1.... para cargar 2 imagenes
            constructor(gl,x1,y1,x2,y2,x3,y3,x4,y4,x,y,x0,y0) {
            /* Coordenadas cartesianas (x, y) */
                let vertices = [
                x1,y1, // 0
                x2,y1, // 1

                x2,y2, // 2
                x1,y2, // 3

                x3,y3, // 0
                x4,y3, // 1

                x4,y4, // 2
                x3,y4, // 3

                x,y,x0,y0,
                ];

                /* Coordenadas de textura (u, v) */
                let coord_textura = [
                0, 0, // 0
                1, 0, // 1
                1, 1, // 2
                0, 1, // 3
                ];

                this.rectanguloVAO = gl.createVertexArray();
                gl.bindVertexArray(this.rectanguloVAO);

                let codigoVertices = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, codigoVertices);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(0);
                gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

                let codigoCoordenadasDeTextura = gl.createBuffer();
                gl.bindBuffer(gl.ARRAY_BUFFER, codigoCoordenadasDeTextura);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(coord_textura), gl.STATIC_DRAW);
                gl.enableVertexAttribArray(1);
                gl.vertexAttribPointer(1, 2, gl.FLOAT, false, 0, 0);

                gl.bindVertexArray(null);
                gl.bindBuffer(gl.ARRAY_BUFFER, null);

            }

            muestra(gl) {
                gl.bindVertexArray(this.rectanguloVAO);
                gl.drawArrays(gl.TRIANGLE_FAN, 0, 4);
                gl.bindVertexArray(null);
            }

        }

        function leeLaTextura(gl, ID_del_archivo, codigoDeTextura) {

            gl.bindTexture(gl.TEXTURE_2D, codigoDeTextura);
            gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL, true);

            let imagen = document.getElementById(ID_del_archivo);

            /* Se lee la textura */
            /* |  tipo   |0=1 resol|RGB/RGBA |orden col|tip datos| buffer  | */
            /* |    1    |    2    |    3    |    4    |    5    |    6    | */	    
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, imagen);

            /* Para que el patrón de textura se agrande y se acomode a una área grande */
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);

            /* Para que el patrón de textura se reduzca y se acomode a una área pequeña */
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);

            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.REPEAT);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.REPEAT);

            gl.bindTexture(gl.TEXTURE_2D, null);

        }

        function dibuja() {
            gl.clear(gl.COLOR_BUFFER_BIT);

            gl.activeTexture(gl.TEXTURE0);
            gl.uniform1i(uUnidadDeTextura, 0); //una imgaen 0 , dos 1 tres 2
            //--------------------mover pista--------------------
            identidad(MatrizModelo);
            traslacion(MatrizModelo,0,p3,0);
            
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdt_3); //por cada imagen un codigo de textura
            texturapista_3.muestra(gl);

            identidad(MatrizModelo);
            traslacion(MatrizModelo,0,p2,0);
            
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdt_2); //por cada imagen un codigo de textura
            texturapista_2.muestra(gl);
            //------------------------------------------------------------------

            identidad(MatrizModelo);
            traslacion(MatrizModelo,0,p1,0);
            
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdt_1); //por cada imagen un codigo de textura
            texturapista_1.muestra(gl);
            //----------auto 1-----------------
            identidad(MatrizModelo);
            traslacion(MatrizModelo,ax1,ay1,0);
            
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdta_1); //por cada imagen un codigo de textura
            texturaauto_1.muestra(gl);
            //----------auto 2--------------------
            identidad(MatrizModelo);
            traslacion(MatrizModelo,ax2,ay2,0);
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdta_2); //por cada imagen un codigo de textura
            texturaauto_2.muestra(gl);
            //-----------auto 3----------------------------
            identidad(MatrizModelo);
            traslacion(MatrizModelo,ax3,ay3,0);
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.bindTexture(gl.TEXTURE_2D, cdta_3); //por cada imagen un codigo de textura
            texturaauto_3.muestra(gl);

            if(inicio ==1 ){
                p1=p1-velocidad;
                p2=p2-velocidad;
                p3=p3-velocidad;
                if (p2<= -20) {
                    p2=p2+20;
                }
                if (p3<= -30) {
                    p3=p3+20;
                }
            }
            if(partir ==1){
            }
            
           document.addEventListener('keydown',(event)=>{
                // Parámetros de velocidad de la IA y el Jugador
                const aceleraauto = 0.0003;
                const desplazarauto = 0;
                
                const acelera1 = 0.0005;
                const acelera3 = 0.0007;

                const desplazar=0.0002;

                switch (event.key) {
                case 'ArrowUp':
                    inicio = 1;
                    partir = 1;
                    
                    ay2 += 0.0002; 

                    ay1 += 0.0003 * (1.5 + Math.random()); 
                    ay3 -= 0.0002 * (1.0 + Math.random()); 
            
                    break;
                case 'ArrowDown':
                    ay2 -= 0.0002; 

                    ay1 -= 0.00025 * (1.5 + Math.random()); 
                    ay3 += 0.0003 * (1.0 + Math.random());
                    
                    break;

                case 'ArrowLeft':
                    ax2 -= 0.0002;
                    
                    ax1 += 0.00015;
                    ax3 -= 0.00015;
                    
                    break;
                case 'ArrowRight':
                    ax2 += 0.0002 ;

                    ax1 -= 0.00015;
                    ax3 += 0.00015;
                    
                    break;
                }
                
                const minX = -1.7;
                const maxX = 1.6;
                
                // Restricción Auto 1
                if (ax1 < minX) ax1 = minX;
                if (ax1 > maxX) ax1 = maxX;
                
                // Restricción Auto 2 (Jugador)
                if (ax2 < minX) ax2 = minX;
                if (ax2 > maxX) ax2 = maxX;
                
                // Restricción Auto 3
                if (ax3 < minX) ax3 = minX;
                if (ax3 > maxX) ax3 = maxX;
                
            });         
            
            requestAnimationFrame(dibuja);
        }
        function main() {

            /* Paso 1: Se prepara el lienzo y se obtiene el contexto del WebGL.        */
            let canvas = document.getElementById("webglcanvas");

            gl = canvas.getContext("webgl2");
            if (!gl) {
                document.write("WebGL 2.0 no está disponible en tu navegador");
                return;
            }

            // Se define la ventana de despliegue
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            compilaEnlazaLosShaders();
            //pista_1
            texturapista_1 = new Rectangulo(gl,-5,-5,5,5);
            cdt_1 = gl.createTexture();
            leeLaTextura(gl, "imagenpista_1", cdt_1)

            texturapista_2 = new Rectangulo(gl,-5,5,5,15);
            cdt_2 = gl.createTexture();
            leeLaTextura(gl, "imagenpista_2", cdt_2)

            texturapista_3 = new Rectangulo(gl,-5,15,5,25);
            cdt_3 = gl.createTexture();
            leeLaTextura(gl, "imagenpista_3", cdt_3)
            //textura auto1
            texturaauto_1 = new Rectangulo(gl,-2.3,-4.9,-0.8,-3);
            cdta_1 = gl.createTexture();
            leeLaTextura(gl, "imagenauto_1", cdta_1)
            //auto 2
            texturaauto_2 = new Rectangulo(gl,-0.8,-4.95,0.8,-2.95);
            cdta_2 = gl.createTexture();
            leeLaTextura(gl, "imagenauto_2", cdta_2)
            //auto 3
            texturaauto_3 = new Rectangulo(gl,0.6,-5.05,2.35,-2.85);
            cdta_3 = gl.createTexture();
            leeLaTextura(gl, "imagenauto_3", cdta_3)

            gl.useProgram(programaID);
            uMatrizProyeccion = gl.getUniformLocation(programaID, "uMatrizProyeccion");
            uMatrizVista = gl.getUniformLocation(programaID, "uMatrizVista");
            uMatrizModelo = gl.getUniformLocation(programaID, "uMatrizModelo");
            uUnidadDeTextura = gl.getUniformLocation(programaID, "uUnidadDeTextura");

            ortho(MatrizProyeccion, -5, 5, -5, 5, -1, 1);
            gl.uniformMatrix4fv(uMatrizProyeccion, false, MatrizProyeccion);

            identidad(MatrizVista);
            gl.uniformMatrix4fv(uMatrizVista, false, MatrizVista);

            gl.enable(gl.BLEND);
            gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

            gl.clearColor(0.0, 0.0, 0.0, 1.0);

            dibuja();

        }
        window.onload = main;
    </script>
</body>
</html> 